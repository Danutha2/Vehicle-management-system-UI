<div class="container mt-4">
  <h3 class="mb-4">Vehicle Records Lookup</h3>

  <!-- Search Options Row -->
  <div class="row mb-4">
    <!-- VIN Direct Search -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Search by VIN</h6>
          <div class="input-group">
            <input 
              type="text" 
              class="form-control" 
              placeholder="Enter VIN..." 
              [(ngModel)]="searchVIN"
              (keyup.enter)="searchByVIN()">
            <button 
              class="btn btn-primary" 
              (click)="searchByVIN()"
              [disabled]="!searchVIN.trim()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
          <small class="text-muted">Returns all fields for the vehicle</small>
        </div>
      </div>
    </div>

    <!-- Vehicle Dropdown Selection -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Select from List</h6>
          <select 
            class="form-select" 
            [(ngModel)]="selectedVIN" 
            (change)="onVehicleDropdownChange()">
            <option value="">-- Select a Vehicle --</option>
            <option *ngFor="let v of vehicles" [value]="v.vin">
              {{ v.vin }} - {{ v.car_make }} {{ v.car_model }}
            </option>
          </select>
          <small class="text-muted">Choose fields to display</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Field Selection Panel (Only for Dropdown Selection) -->
  <div *ngIf="showFieldSelection" class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-ui-checks"></i> Select Fields to Display
        <span *ngIf="isFieldSelectionLocked" class="badge bg-success float-end">
          <i class="bi bi-lock-fill"></i> Locked
        </span>
      </h5>
    </div>
    <div class="card-body">
      
      <!-- Vehicle Fields Section -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">
            <strong>Vehicle Information Fields</strong>
            <span class="badge bg-secondary ms-2">{{ selectedVehicleFields.length }} selected</span>
          </h6>
          <div *ngIf="!isFieldSelectionLocked">
            <button class="btn btn-sm btn-outline-primary me-1" (click)="selectAllVehicleFields()">
              Select All
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="clearAllVehicleFields()">
              Clear All
            </button>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-3 col-sm-6" *ngFor="let f of vehicleFields">
            <div class="form-check mb-2">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'vf-' + f"
                [checked]="selectedVehicleFields.includes(f)" 
                (change)="toggleVehicleField(f)"
                [disabled]="isFieldSelectionLocked">
              <label class="form-check-label" [for]="'vf-' + f" 
                     [class.text-muted]="isFieldSelectionLocked">
                {{ getLabel(f) }}
              </label>
            </div>
          </div>
        </div>
      </div>

      <hr>

      <!-- Service Record Fields Section -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">
            <strong>Service Record Fields</strong>
            <span class="badge bg-secondary ms-2">{{ selectedRecordFields.length }} selected</span>
          </h6>
          <div *ngIf="!isFieldSelectionLocked">
            <button class="btn btn-sm btn-outline-primary me-1" (click)="selectAllRecordFields()">
              Select All
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="clearAllRecordFields()">
              Clear All
            </button>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-3 col-sm-6" *ngFor="let f of recordFields">
            <div class="form-check mb-2">
              <input 
                class="form-check-input" 
                type="checkbox" 
                [id]="'rf-' + f"
                [checked]="selectedRecordFields.includes(f)" 
                (change)="toggleRecordField(f)"
                [disabled]="isFieldSelectionLocked">
              <label class="form-check-label" [for]="'rf-' + f"
                     [class.text-muted]="isFieldSelectionLocked">
                {{ getLabel(f) }}
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Warning Message -->
      <div *ngIf="!selectedVehicleFields.length || !selectedRecordFields.length" 
           class="alert alert-warning mb-3">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Warning:</strong> Please select at least one field from both Vehicle Information and Service Records sections.
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2">
        <button 
          *ngIf="!isFieldSelectionLocked"
          class="btn btn-success" 
          (click)="loadSelectedData()"
          [disabled]="!selectedVehicleFields.length || !selectedRecordFields.length">
          <i class="bi bi-download"></i> Load Data
        </button>
        
        <button 
          class="btn btn-warning" 
          (click)="resetSelection()">
          <i class="bi bi-arrow-counterclockwise"></i> Reset Selection
        </button>
      </div>

      <!-- Info Message when Locked -->
      <div *ngIf="isFieldSelectionLocked" class="alert alert-info mt-3 mb-0">
        <i class="bi bi-info-circle-fill"></i>
        Field selection is locked. Click <strong>Reset Selection</strong> to choose different fields.
      </div>
    </div>
  </div>

  <!-- Vehicle Information Display -->
  <div *ngIf="vehicleInfo && isDataLoaded" class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">
        <i class="bi bi-car-front-fill"></i> Vehicle Information
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 col-lg-4 mb-3" *ngFor="let field of selectedVehicleFields">
          <div class="d-flex flex-column">
            <small class="text-muted text-uppercase fw-bold">{{ getLabel(field) }}</small>
            <span class="fs-6">{{ vehicleInfo[field] || 'N/A' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Service Records Table -->
  <div *ngIf="serviceRecords.length && isDataLoaded" class="card shadow-sm">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">
        <i class="bi bi-tools"></i> Service Records 
        <span class="badge bg-light text-dark float-end">{{ serviceRecords.length }} records</span>
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
          <thead class="table-dark">
            <tr>
              <th *ngFor="let f of selectedRecordFields">{{ getLabel(f) }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of serviceRecords; let i = index">
              <td *ngFor="let f of selectedRecordFields">{{ r[f] || 'N/A' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- No Records Message -->
  <div *ngIf="isDataLoaded && vehicleInfo && !serviceRecords.length" class="alert alert-warning">
    <i class="bi bi-exclamation-circle"></i>
    No service records found for this vehicle.
  </div>

  <!-- Empty State -->
  <div *ngIf="!vehicleInfo && !showFieldSelection" class="text-center text-muted py-5">
    <i class="bi bi-search" style="font-size: 3rem;"></i>
    <p class="mt-3">Search for a vehicle using VIN or select from the dropdown list</p>
  </div>
</div>

<!-- Optional: Add Bootstrap Icons if not already included -->
<!-- Add this to your index.html or angular.json:
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
-->